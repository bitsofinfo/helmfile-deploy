# Example

Below is a basic example. Post install/upgrade alerts will be sent to the https://bitsofinfo.slack.com `#bitsofinfo-dev` channel ([self signup to channel](https://join.slack.com/t/bitsofinfo/shared_invite/enQtNjY1ODIzNTkyMDMyLTEzZGUwNzExOWYyMmZmMTQyYWZiYzJjYTJkNGI3MWMzNzQ3MTE2NzVhM2Q1ZjE4OGViYjA1NGY4MzdiZDg3ZWI))

This should be enough to get your feet wet.

## Setup

You **MUST** have `helm` installed.

You **MUST** have `helmfile` installed: https://github.com/roboll/helmfile and be using a version **>= 0.79.4**

**IMPORTANT!:**
Before we continue we need to setup an `IngressController` [lets use Traefik, click here for setup instructions](https://github.com/bitsofinfo/appdeploy/blob/master/examples/TRAEFIK_SETUP.md)

For this example: your `/etc/hosts` (unless you have DNS setup) should have an entry with the contents of [hosts.txt](https://github.com/bitsofinfo/appconduits/blob/master/examples/hosts.txt) (you need to customized w/ your LB IP..)

Finally, ensure the following Helm repos exists on your machine:
```
helm repo add bitsofinfo-appdeploy https://raw.githubusercontent.com/bitsofinfo/appdeploy/master/repo
helm repo add bitsofinfo-appconduits https://raw.githubusercontent.com/bitsofinfo/appconduits/master/repo
helm repo update
```

## First: we need to declare some locations for `helmfile-deploy`

This variable designates where your custom `helmfile` *state values* can be found. Within this directory you can have one or more custom `*.yaml` that override and customize known `helmfile-deploy` state values defined in [values/](../values) Its important to note that these values are not `helm` chart values, but rather values that are consumed by the helmfile release templates themselves.
```
export HELMFILE_DEPLOY_STATE_VALUES_DIR=examples/values
```

This variable designates where your custom `helmfile` *environments* found. This directory should declare a single `index.yaml` that declares your helmfile `environments:` block. For the purposes of the `helmfile-deploy` framework, each helmfile *environment* represents a target application that can be deployed.
```
export HELMFILE_DEPLOY_ENVIRONMENTS_DIR=examples/environments
```

## Lets deploy all defined "releases" of "catapp"

Running this will ensure all defined `services` within the `catapp` *environment* (defined in [environments/catapp/stage-qa.yaml](environments/catapp/stage-qa.yaml)) under the *context* `stage-qa` are running against the `targetCluster=minikube`

A unique helmfile `release` is defined for each of the latter using the `deployments.helmfile.yaml` helmfile YAML which subsequently invokes `helm` using the [appdeploy](https://github.com/bitsofinfo/appdeploy) helm chart.

```
./helmfile \
  --log-level debug \
  --file deployments.helmfile.yaml \
  --state-values-set targetCluster=minikube \
  --namespace bitsofinfo-apps \
  --selector context=stage-qa \
  --environment catapp \
  --state-values-set chartConfigs.appdeploy.chartValues.baseValuesRootDir=examples/chartvalues/appdeploy \
  apply
```

Once this is complete we can access each installed app via its auto generated version specific name as generated by the [appdeploy](https://github.com/bitsofinfo/appdeploy) chart that `helmfile` invoked:
```
curl http://catapp-stage-qa-2-0-0-80.local
curl http://catapp-stage-qa-3-0-0-80.local
curl http://catapp-stage-qa-4-0-0-80.local
```


## Lets deploy all defined "conduits" for "catapp"

Running this will ensure all defined `ingress` within the `catapp` *environment* (defined in [environments/catapp/stage-qa.yaml](environments/catapp/stage-qa.yaml)) under the *context* `stage-qa` are running against the `targetCluster=minikube`

A unique helmfile `release` is defined for each of the latter using the `conduits.helmfile.yaml` helmfile YAML which subsequently invokes `helm` using the [appconduits](https://github.com/bitsofinfo/appconduits) helm chart.

```
./helmfile \
  --log-level debug \
  --file conduits.helmfile.yaml \
  --state-values-set targetCluster=minikube \
  --namespace bitsofinfo-apps \
  --selector context=stage-qa \
  --environment catapp \
  --state-values-set chartConfigs.appconduits.chartValues.baseValuesRootDir=examples/chartvalues/appconduits \
  apply
```

Once this is complete we can access "catapp" via its custom `Ingress/Services` name/ingress as generated by the [appconduits](https://github.com/bitsofinfo/appconduits) chart that `helmfile` invoked:

|Expect|target|
|---|---|
|catapp:4.0.0 or 3.0.0 or 2.0.0|`curl http://catapp-mixed.mydomain.com`|
|catapp:3.0.0|`curl http://catapp-current.mydomain.com`|
|catapp:2.0.0|`curl http://catapp-previous.mydomain.com`|
|catapp:4.0.0|`curl http://catapp-next.mydomain.com`|


|Expect|target|
|---|---|
|RED catapp:4.0.0 or 3.0.0 or 2.0.0|`curl http://animals.mydomain.com/red`|
|ORANGE catapp:4.0.0 or 3.0.0 or 2.0.0|`curl http://animals.mydomain.com/orange`|
|RED catapp:4.0.0|`curl http://animals-next.mydomain.com/red`|
|ORANGE catapp:4.0.0|`curl http://animals-next.mydomain.com/orange`|
|RED catapp:3.0.0|`curl http://animals-current.mydomain.com/red`|
|ORANGE catapp:3.0.0|`curl http://animals-current.mydomain.com/orange`|
|RED catapp:2.0.0|`curl http://animals-previous.mydomain.com/red`|
|ORANGE catapp:2.0.0|`curl http://animals-previous.mydomain.com/orange`|

## Next lets do the same for hogapp

Note that **hogapp** exposes multiple ports and it's [environments/hogapp/chartconfigs.yaml](environments/hogapp/chartconfigs.yaml)
reflects that by overriding the default `containerPorts` it would otherwise end up using as defined in [chartvalues/appdeploy/values/testapps/values.yaml](chartvalues/appdeploy/values/testapps/values.yaml)

Ensure all *hogapp* deployment releases:
```
./helmfile \
  --log-level debug \
  --file deployments.helmfile.yaml \
  --state-values-set targetCluster=minikube \
  --namespace bitsofinfo-apps \
  --selector context=stage-qa \
  --environment hogapp \
  --state-values-set chartConfigs.appdeploy.chartValues.baseValuesRootDir=examples/chartvalues/appdeploy \
  apply
```

```
curl http://hogapp-stage-qa-2-0-0-80.local
curl http://hogapp-stage-qa-3-0-0-80.local
curl http://hogapp-stage-qa-4-0-0-80.local
curl http://hogapp-stage-qa-2-0-0-443.local
curl http://hogapp-stage-qa-3-0-0-443.local
curl http://hogapp-stage-qa-4-0-0-443.local
```

Ensure all *hogapp* conduit releases:
```
./helmfile \
  --log-level debug \
  --file conduits.helmfile.yaml \
  --state-values-set targetCluster=minikube \
  --namespace bitsofinfo-apps \
  --selector context=stage-qa \
  --environment hogapp \
  --state-values-set chartConfigs.appconduits.chartValues.baseValuesRootDir=examples/chartvalues/appconduits \
  apply
```

|Expect|target|
|---|---|
|hogapp:4.0.0 or 3.0.0 or 2.0.0|`curl http://hogapp-mixed.mydomain.com`|
|hogapp:3.0.0|`curl http://hogapp-current.mydomain.com`|
|hogapp:2.0.0|`curl http://hogapp-previous.mydomain.com`|
|hogapp:4.0.0|`curl http://hogapp-next.mydomain.com`|


|Expect|target|
|---|---|
|BROWN hogapp:4.0.0 or 3.0.0 or 2.0.0|`curl http://animals.mydomain.com/brown`|
|PINK hogapp:4.0.0 or 3.0.0 or 2.0.0|`curl http://animals.mydomain.com/pink`|
|BROWN hogapp:4.0.0|`curl http://animals-next.mydomain.com/brown`|
|PINK hogapp:4.0.0|`curl http://animals-next.mydomain.com/pink`|
|BROWN hogapp:3.0.0|`curl http://animals-current.mydomain.com/brown`|
|PINK hogapp:3.0.0|`curl http://animals-current.mydomain.com/pink`|
|BROWN hogapp:2.0.0|`curl http://animals-previous.mydomain.com/brown`|
|PINK hogapp:2.0.0|`curl http://animals-previous.mydomain.com/pink`|

## Next lets do the same for dogapp

Ensure all *dogapp* deployment releases:
```
./helmfile \
  --log-level debug \
  --file deployments.helmfile.yaml \
  --state-values-set targetCluster=minikube \
  --namespace bitsofinfo-apps \
  --selector context=stage-qa \
  --environment dogapp \
  --state-values-set chartConfigs.appdeploy.chartValues.baseValuesRootDir=examples/chartvalues/appdeploy \
  apply
```

```
curl http://dogapp-stage-qa-2-0-0-80.local
curl http://dogapp-stage-qa-3-0-0-80.local
curl http://dogapp-stage-qa-4-0-0-80.local
```

Ensure all *dogapp* conduit releases:
```
./helmfile \
  --log-level debug \
  --file conduits.helmfile.yaml \
  --state-values-set targetCluster=minikube \
  --namespace bitsofinfo-apps \
  --selector context=stage-qa \
  --environment dogapp \
  --state-values-set chartConfigs.appconduits.chartValues.baseValuesRootDir=examples/chartvalues/appconduits \
  apply
```

|Expect|target|
|---|---|
|dogapp:4.0.0 or 3.0.0 or 2.0.0|`curl http://dogapp-mixed.mydomain.com`|
|dogapp:3.0.0|`curl http://dogapp-current.mydomain.com`|
|dogapp:2.0.0|`curl http://dogapp-previous.mydomain.com`|
|dogapp:4.0.0|`curl http://dogapp-next.mydomain.com`|

|Expect|target|
|---|---|
|dogapp:4.0.0 or 3.0.0 or 2.0.0|`curl http://animals.mydomain.com`|
|dogapp:4.0.0|`curl http://animals-next.mydomain.com`|
|dogapp:3.0.0|`curl http://animals-current.mydomain.com`|
|dogapp:2.0.0|`curl http://animals-previous.mydomain.com`|
|BLUE dogapp:4.0.0 or 3.0.0 or 2.0.0|`curl http://animals.mydomain.com/blue`|
|GREEN dogapp:4.0.0 or 3.0.0 or 2.0.0|`curl http://animals.mydomain.com/green`|
|BLUE dogapp:4.0.0|`curl http://animals-next.mydomain.com/blue`|
|GREEN dogapp:4.0.0|`curl http://animals-next.mydomain.com/green`|
|BLUE dogapp:3.0.0|`curl http://animals-current.mydomain.com/blue`|
|GREEN dogapp:3.0.0|`curl http://animals-current.mydomain.com/green`|
|BLUE dogapp:2.0.0|`curl http://animals-previous.mydomain.com/blue`|
|GREEN dogapp:2.0.0|`curl http://animals-previous.mydomain.com/green`|
